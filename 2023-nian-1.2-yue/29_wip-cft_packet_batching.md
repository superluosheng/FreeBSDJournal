# WIP/CFT：数据包批处理

在过去的 30 年里，我们所使用的计算机的发展速度之快令人难以想象。1995 年 Alpha AXP 的论文谈到了机器的设计，它延续了前 25 年的趋势，速度提高了 1000 倍。

我们当然已经实现了这个目标，作为 FreeBSD 最初目标的 386 机器类似于我们今天在键盘中使用的微控制器。

即使有了这些变化，计算机性能的核心仍然保持不变，每单位工作执行的指令更少，而且速度会更快。这种网络化的基本事实导致了几种不同的方法来提高性能。我们已经研究了将工作从 CPU 转移到带有校验和卸载的网卡的机制。如果用这种卡运行指令来校验输出的数据包，那么我们宝贵的 CPU 时间可以用来做其他事情。

校验和卸载看到了很好的结果，我们开始将其他东西从 CPU 转移到网络接口。TCP 分段卸载（TSO）是提高网络发送器性能的下一个伟大机制。我们可以形成一个模板，并将其与一大块数据一起发送到卡上，而不是为我们将要发送的 TCP 段形成 IP 数据包。网络接口在将数据包放置到线缆上时处理分段。TSO为 TCP 发送器带来了巨大的好处，使我们能够在耗尽单个核心之前就使 10G 网络接口饱和。

TSO 让我们能够利用宝贵的资源提高效率。我们减少了发送每个数据包所需的总线（内存和 PCI ）事务的数量，方法是将它们批处理在一起，并在传输点创建最终块。对于 TCP 来说，这是直接的，大多数时候，如果我们正在批量发送数据流，并且数据块是清晰的。为了在 TCP 接收器上反映这些改进，我们有大型接收卸载（LRO）。LRO 使我们能够再次减少维持高速数据传输所需的事务数量。

对于 UDP ，Linux 有一些通用机制，试图复制类似 TSO 的机制。此支持由通用分段卸载（GSO）和通用接收卸载（GRO）一起提供。GSO 在顺序上实现了巨大的改进，对于 UDP 发送器来说，可以提高 20%，GRO 更难测量，但机制是存在的。

FreeBSD 对 TSO 和 LRO 有很好的支持，但缺乏类似于 GSO 和 GRO 的机制。去年在维也纳的 EuroBSDCon ，我与 John Baldwin 谈论了他正在研究的一种类似于 GRO 的机制，他称之为 Packet Batching。

 - **TJ：** 数据包批处理工作的背景是什么？

**JB：** 在接收时进行数据包批处理的想法已经存在了一段时间，至少是以我多次听到各种人提到的愿望列表项目的形式。我们已经有一些特定于TCP的用于发送（TSO）和接收（LRO）的数据包批处理形式。这种数据包批处理旨在比 LRO 更通用，以便它可以应用于其他协议（主要是 UDP）。

 - **TJ：** 为什么需要做这项工作？

**JB：** TSO 和 LRO 等数据包批处理方法的目标是通过每批进行一次而不是每包进行一次来摊销每包成本（网络堆栈中对报头字段的各种检查等）。随着网络速度的增长速度快于CPU速度，每包开销的成本成为一个越来越严重的问题。的确，通常情况下，解决这个问题的方法之一是通过使用RSS在绑定到不同CPU的单独队列中分发数据包来进行横向扩展，这确实有助于解决每个数据包的开销。然而，您不能在多个核心之间分配单个流，批处理方案旨在提高单个队列的性能。

 - **TJ：** 这项工作使哪些新功能/增强成为可能？

**JB：** 目标是提高 PPS 和/或减少网络接收工作负载的 CPU 使用量。当启用 LRO 时，我不希望它对 TCP 有帮助，主要是对 UDP 有帮助。

 - **TJ：** 人们如何测试这个工作？通常，我们需要强调使用更多的分布式工作负载进行测试，这在这里适用吗？

**JB：** 欢迎进行基准测试。我最初使用 iperf3 的一组简单基准测试是好坏参半的，并且没有足够明显的收获来证明这些更改是合理的。这些变化确实增加了复杂性，所以我认为，在将其视为提交候选之前，它需要在某些工作负载中取得明显的收获。到目前为止，我还没有观察到我的基准出现任何倒退，只是测量到零收益。

 - **TJ：** 你希望得到什么样的反馈？

**JB：** 直接给我发电子邮件可能是目前发送反馈的最佳方式。在未来的某个时刻，我将在 net@ 和/或 arch@ 上启动一个公共 RFC 线程，届时该线程将是发送反馈的最佳位置。想要测试补丁或查看补丁的人可以在 https://github.com/freebsd/freebsd-src/compare/main...bsdjhb:-freebsd:cxgbe_batching 查找。

从 John 在这里的回应来看，还不清楚应该从哪里看到收益。iperf3 测量无法模拟非常繁忙的服务器的工作负载。对于 FreeBSD 中的数据包批处理来说，可能需要测试和调整更多的工作负载。通过关闭 John 的 github 分支并用您的网络流量实验，您可以帮助在 FreeBSD 中建立新的接收器优化。

---
**TOM JONES** 希望基于 FreeBSD 的项目得到应有的关注。他住在苏格兰东北部，提供 FreeBSD 咨询服务。
**JOHN BALDWIN** 是一名系统软件开发人员。20 年来，他直接致力于在内核的各个部分（包括 x86 平台支持、SMP、各种设备驱动程序和虚拟内存子系统）和用户空间程序中对 FreeBSD 操作系统进行更改。除了编写代码，John 还在 FreeBSD 核心和发布工程团队中任职。他还为 GDB 调试器和 LLVM 做出了贡献。John 和他的妻子 Kimberly 以及三个孩子 Janelle、Evan 和 Bella 住在加利福尼亚州的康科德。

